<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>Test create</title>
    <link rel="stylesheet" href="../bower_components/mocha/mocha.css">
    <script src="../bower_components/on/dist/on.js"></script>
    <script src="../bower_components/dom/src/dom.js"></script>
    <script src="../src/create.js"></script>
    <script src="../src/attrs.js"></script>
    <script src="../src/refs.js"></script>
    <script src="../src/template.js"></script>
    <script src="../bower_components/mocha/mocha.js"></script>
    <script src="../bower_components/chai/chai.js"></script>
    <style>
        body{
            padding: 20px;
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <h1>create test</h1>
    <div id="mocha"></div>

    <template id="test-widget2-template">
        <div ref="testNode">has template</div>
    </template>
    <script>

        create({
            tag: 'test-widget4',
            value:{
                set: function (value) {
                    this.__value = value;
                    this.reflect('value', value);
                },
                get: function () {
                    return this.__value;
                }
            },
            _ARR:[1,2,3],
            _OBJ:{
                a:1,
                b:true,
                c:'string'
            },
            _STR: 'string',
            _BOOL: true,
            _NUM: 99,
            setStuff: function (stuff) {
                this._stuff = stuff;
            },
            getStuff: function () {
                return this._stuff;
            },
            set foo (value) {
                this.__foo = value;
                this.reflect('foo', value);
            },
            get foo () {
                return this.__foo;
            },
            set bar (value) {
                this.__bar = value;
            },
            get bar () {
                return this.__bar;
            }
        });
    </script>
    <div id="widgets">
        <test-widget4 foo="stuff" bar="100" value="boom"></test-widget4>
    </div>
    <script>

        mocha.setup('tdd');

        suite('keys', function() {
            this.timeout(3000);
            var suite = window.suite,
                test = window.test,
                dom = window.dom,
                on = window.on,
                expect = chai.expect,
                widgets = dom.byId('widgets');

            function xsuite () {}
            function xtest () {}

            suite('create-element', function () {
                suite('create', function () {

                    // components can be created in suites, but not in tests
                    // can't call function from within tests either
                    create({
                        tag: 'test-widget'
                    });
                    create({
                        tag: 'test-widget2',
                        templateId: 'test-widget2-template'
                    });
                    create({
                        tag: 'test-widget3',
                        value:{
                            set: function (value) {
                                this.__value = value;
                            },
                            get: function () {
                                return this.__value;
                            }
                        },
                        set disabled (value) {
                            this.__disabled = value;
                        },
                        get disabled () {
                            return this.__disabled || false;
                        }
                    });


                    test('it should create a component', function () {
                        dom('test-widget', {html:'<pre>test widget</pre>'}, widgets);
                        var node = dom.query('test-widget');
                        expect(node).to.not.equal(null);
                    });
                    test('it should create a component with a template', function () {
                        dom('test-widget2', {html:'<div>test-widget2</div>'}, widgets);
                        var node = dom.query('test-widget2');
                        expect(node).to.not.equal(null);
                        expect(node.innerHTML.indexOf('has template') > -1).to.equal(true);
                        window.node = node;
                        expect(dom.isNode(node.testNode)).to.equal(true);
                    });
                    test('it should use getter/setters', function () {
                        dom('test-widget3', 0, widgets);
                        var node = dom.query('test-widget3');
                        node.value = 'foo';
                        expect(node.value).to.equal('foo');
                        expect(node.disabled).to.equal(false);
                        node.disabled = true;
                        expect(node.disabled).to.equal(true);

                    });
                    test('it should set properties from attributes if there is a setter (markup)', function () {
                        var node = dom.query('test-widget4');
                        expect(node.foo).to.equal('stuff');
                        expect(node.bar).to.equal(100);
                        expect(node.value).to.equal('boom');
                    });
                    test('it should set properties from attributes if there is a setter', function (done) {
                        var node = dom('test-widget4', {attr:{foo:true, bar:9, bazz:'none', value:'winning'}}, widgets);

                        create.onDomReady(node, function (node) {
                            expect(node.foo).to.equal(true);
                            expect(node.bar).to.equal(9);
                            expect(node.value).to.equal('winning');
                            // does not set bazz - there is no setter
                            expect(node.bazz).to.equal(undefined);

                            // set again
                            node.setAttribute('foo', 'false');
                            node.setAttribute('bar', '-2');
                            node.setAttribute('value', 'losing');
                            node.setAttribute('bazz', 'whatever');

                            expect(node.foo).to.equal(false);
                            expect(node.bar).to.equal(-2);
                            expect(node.value).to.equal('losing');
                            // does not set bazz - there is no setter
                            expect(node.bazz).to.equal(undefined);


                            node.setAttribute('foo', '');
                            expect(node.foo).to.equal('');

                            node.removeAttribute('foo');
                            expect(node.foo).to.equal(null);

                            done();
                        });
                    });
                    test('it should copy native types, including getter/setters', function (done) {
                        var node = dom('test-widget4', {}, widgets);

                        create.onDomReady(node, function (node) {
                            node.value = 'tying';
                            node.foo = 'woo';
                            node.bar = 'pipe';
                            node.setStuff('stuffing');
                            expect(node.value).to.equal('tying');
                            expect(node.foo).to.equal('woo');
                            expect(node.bar).to.equal('pipe');

                            expect(node.getStuff()).to.equal('stuffing');

                            expect(node._OBJ.a).to.equal(1);
                            expect(node._OBJ.b).to.equal(true);
                            expect(node._OBJ.c).to.equal('string');

                            expect(node._ARR.length).to.equal(3);
                            expect(node._NUM).to.equal(99);
                            expect(node._STR).to.equal('string');
                            expect(node._BOOL).to.equal(true);

                            done();
                        });
                    });
                    test('it should reflect properties to attributes', function (done) {
                        var node = dom('test-widget4', {}, widgets);

                        create.onDomReady(node, function (node) {
                            node.value = 'tying';
                            node.foo = 'woo';
                            node.bar = 'pipe';
                            expect(node.getAttribute('value')).to.equal('tying');
                            expect(node.getAttribute('foo')).to.equal('woo');
                            expect(node.getAttribute('bar')).to.equal(null);
                            done();
                        });
                    });

                    // TODO: lifecycle (change to connect/disconnect)
                    // TODO: test on/remove
                });
            });
        });

        mocha.run();

    </script>
</body>
</html>