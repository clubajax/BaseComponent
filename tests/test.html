<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>Test create</title>
    <link rel="stylesheet" href="../bower_components/mocha/mocha.css">
    <script src="../bower_components/on/dist/on.js"></script>
    <script src="../bower_components/dom/src/dom.js"></script>
    <script src="../src/create.js"></script>
    <script src="../src/attrs.js"></script>
    <script src="../src/refs.js"></script>
    <script src="../src/template.js"></script>
    <script src="../bower_components/mocha/mocha.js"></script>
    <script src="../bower_components/chai/chai.js"></script>
    <script src="//localhost:35731/livereload.js"></script>
    <style>
        body{
            padding: 20px;
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <h1>create test</h1>
    <div id="mocha"></div>

    <template id="test-widget2-template">
        <div ref="testNode">has template</div>
    </template>
    <script>
        // components can be created in suites, but not in tests
        // can't call function from within tests either
        create({
            tag: 'test-widget'
        });
        create({
            tag: 'test-widget2',
            templateId: 'test-widget2-template'
        });
        create({
            tag: 'test-widget3',
            value:{
                set: function (value) {
                    this.__value = value;
                },
                get: function () {
                    return this.__value;
                }
            },
            set disabled (value) {
                this.__disabled = value;
            },
            get disabled () {
                return this.__disabled || false;
            }
        });
        create({
            tag: 'test-widget5',
            created: function () {
                on.fire(window, 'create-called');
            },
            domReady: function () {
                on.fire(window, 'domReady-called');
            }
        });
        create({
            tag: 'test-child1',
            domReady: function () {
                on.fire(window, 'domReady-called');
            }
        });
        create({
            tag: 'test-widget6',
            templateString: '<div ref="tNode">has string template</div>'
        });
        create({
            tag: 'test-widget4',
            value:{
                set: function (value) {
                    this.__value = value;
                    this.reflect('value', value);
                },
                get: function () {
                    return this.__value;
                }
            },
            _ARR:[1,2,3],
            _OBJ:{
                a:1,
                b:true,
                c:'string'
            },
            _STR: 'string',
            _BOOL: true,
            _NUM: 99,
            setStuff: function (stuff) {
                this._stuff = stuff;
            },
            getStuff: function () {
                return this._stuff;
            },
            set foo (value) {
                this.__foo = value;
                this.reflect('foo', value);
            },
            get foo () {
                return this.__foo;
            },
            set bar (value) {
                this.__bar = value;
            },
            get bar () {
                return this.__bar;
            }
        });
        create({
            tag: 'a-widget',
            id:'a',

            created: function () {
                props.created.push('a');
            },

            attached: function () {
                props.attached.push('a');
            },

            domReady: function () {
                props.domReady.push('a');
                dom('div', {html:'<label>a-widget</label>'}, this);
            },

            base: function () {
                props.base.push(this.id);
            }
        });
        create({
            tag: 'b-widget',
            extends: 'a-widget',
            id:'b',

            created: function () {
                props.created.push('b');
                this.super('created');
            },

            attached: function () {
                props.attached.push('b');
                this.super('attached');
                this.base();
            },

            domReady: function () {
                console.log('DOMREADY B');
                props.domReady.push('b');
                this.super('domReady');
                this.base();
            }
        });
        create({
            tag: 'c-widget',
            extends: 'b-widget',
            id:'c',

            created: function () {
                props.created.push('c');
                this.super('created');
            },

            attached: function () {
                props.attached.push('c');
                this.super('attached');
                this.base();
            },

            domReady: function () {
                console.log('DOMREADY C');
                props.domReady.push('c');
                this.super('domReady');
            }
        });
        create({
            tag: 'd-widget',
            extends: 'a-widget',
            id: 'd'
        });
        create({
            tag: 'e-widget',
            templateString: '<div ref="tNode">has string template</div>'
        });
        create({
            tag: 'f-widget',
            extends: 'e-widget',
            attached: function () {
                console.log('e.attached');
                this.tNode.innerHTML = 'this is extended';
            }
        });
        create({
            tag: 'g-widget',
            extends: 'f-widget'
        });
        create({
            tag: 'h-widget',
            extends: 'g-widget'
        });

        create({
            tag: 'missing-a',
            attached: function () {
                props.attached.push('a');
            },
            base: function () {
                props.base.push('a');
            }
        });
        create({
            tag: 'missing-b',
            extends: 'missing-a'
        });
        create({
            tag: 'missing-c',
            extends: 'missing-b',
            attached: function () {
                props.attached.push('c');
                this.super('attached');
            },
            base: function () {
                props.base.push('c');
                this.super('base');
            }
        });
        create({
            tag: 'missing-d',
            extends: 'missing-c'
        });
        // for collecting inheritance properties
        var props = {
            created:[],
            attached:[],
            base: [],
            domReady: [],
            restore: function () {
                this.created.length = 0;
                this.attached.length = 0;
                this.base.length = 0;
                this.domReady.length = 0;
            }
        };
    </script>
    <div id="widgets">
        <test-widget4 foo="stuff" bar="100" value="boom"></test-widget4>
    </div>
    <script>

        mocha.setup('tdd');

        suite('create-element', function () {
            this.timeout(3000);
            var suite = window.suite,
                test = window.test,
                dom = window.dom,
                on = window.on,
                expect = chai.expect,
                widgets = dom.byId('widgets');

            function xsuite () {}
            function xtest () {}

            xsuite('create', function () {

                test('it should create a component', function () {
                    dom('test-widget', {html:'<pre>test widget</pre>'}, widgets);
                    var node = dom.query('test-widget');
                    expect(node).to.not.equal(null);
                });
                test('it should use getter/setters', function () {
                    dom('test-widget3', 0, widgets);
                    var node = dom.query('test-widget3');
                    node.value = 'foo';
                    expect(node.value).to.equal('foo');
                    expect(node.disabled).to.equal(false);
                    node.disabled = true;
                    expect(node.disabled).to.equal(true);

                });
                test('it should set properties from attributes if there is a setter (markup)', function () {
                    var node = dom.query('test-widget4');
                    expect(node.foo).to.equal('stuff');
                    expect(node.bar).to.equal(100);
                    expect(node.value).to.equal('boom');
                });
                test('it should set properties from attributes if there is a setter', function (done) {
                    var node = dom('test-widget4', {attr:{foo:true, bar:9, bazz:'none', value:'winning'}}, widgets);

                    create.onDomReady(node, function (node) {
                        expect(node.foo).to.equal(true);
                        expect(node.bar).to.equal(9);
                        expect(node.value).to.equal('winning');
                        // does not set bazz - there is no setter
                        expect(node.bazz).to.equal(undefined);

                        // set again
                        node.setAttribute('foo', 'false');
                        node.setAttribute('bar', '-2');
                        node.setAttribute('value', 'losing');
                        node.setAttribute('bazz', 'whatever');

                        expect(node.foo).to.equal(false);
                        expect(node.bar).to.equal(-2);
                        expect(node.value).to.equal('losing');
                        // does not set bazz - there is no setter
                        expect(node.bazz).to.equal(undefined);


                        node.setAttribute('foo', '');
                        expect(node.foo).to.equal('');

                        node.removeAttribute('foo');
                        expect(node.foo).to.equal(null);

                        done();
                    });
                });
                test('it should copy native types, including getter/setters', function (done) {
                    var node = dom('test-widget4', {}, widgets);

                    create.onDomReady(node, function (node) {
                        node.value = 'tying';
                        node.foo = 'woo';
                        node.bar = 'pipe';
                        node.setStuff('stuffing');
                        expect(node.value).to.equal('tying');
                        expect(node.foo).to.equal('woo');
                        expect(node.bar).to.equal('pipe');

                        expect(node.getStuff()).to.equal('stuffing');

                        expect(node._OBJ.a).to.equal(1);
                        expect(node._OBJ.b).to.equal(true);
                        expect(node._OBJ.c).to.equal('string');

                        expect(node._ARR.length).to.equal(3);
                        expect(node._NUM).to.equal(99);
                        expect(node._STR).to.equal('string');
                        expect(node._BOOL).to.equal(true);

                        done();
                    });
                });
                test('it should reflect properties to attributes', function (done) {
                    var node = dom('test-widget4', {}, widgets);

                    create.onDomReady(node, function (node) {
                        node.value = 'tying';
                        node.foo = 'woo';
                        node.bar = 'pipe';
                        expect(node.getAttribute('value')).to.equal('tying');
                        expect(node.getAttribute('foo')).to.equal('woo');
                        expect(node.getAttribute('bar')).to.equal(null);
                        done();
                    });
                });

                // TODO: lifecycle (change to connect/disconnect)
                // TODO: test on/remove
                // TODO: test inheritance
            });

            xsuite('lifecycle methods', function () {
                test('it should call component\'s `created` method', function () {
                    var called = false;
                    on(window, 'create-called', function () {
                        called = true;
                    });
                    dom('test-widget5');
                    expect(called).to.equal(true);
                });
                test('it should call component\'s `domReady` method', function (done) {
                    var node, called = false;
                    on(window, 'domReady-called', function () {
                        called = true;
                    });
                    node = dom('test-widget5', {}, document.body);
                    node.on('domready', function () {
                        expect(called).to.equal(true);
                        done();
                    });
                });
                test('it should call component\'s `domReady` method when children are ready', function (done) {
                    var node, called = 0;
                    on(window, 'domReady-called', function () {
                        called++;
                    });
                    node = dom('test-widget5', {}, document.body);
                    dom('test-child1', {}, node);
                    dom('test-child1', {}, node);
                    dom('test-child1', {}, node);
                    node.on('domready', function () {
                        expect(called).to.equal(4);
                        done();
                    });
                });
                test('it should call component\'s `domReady` method when descendants are ready', function (done) {
                    var node, called = 0;
                    on(window, 'domReady-called', function () {
                        called++;
                    });
                    node = dom('test-widget5', {}, document.body);
                    dom('test-child1', {
                        html: dom('test-child1', {
                            html: dom('test-child1', {
                                html: dom('test-child1', {})
                            })
                        })
                    }, node);
                    node.on('domready', function () {
                        expect(called).to.equal(5);
                        done();
                    });
                });

                // TODO test destroy
            });

            xsuite('templates', function () {
                test('it should create a component with a templateId', function () {
                    var node = dom('test-widget2', {html:'<div>test-widget2</div>'}, widgets);
                    expect(node).to.not.equal(null);
                    expect(node.innerHTML.indexOf('has template') > -1).to.equal(true);
                    expect(dom.isNode(node.testNode)).to.equal(true);
                });
                test('it should create a component with a templateString', function () {
                    var node = dom('test-widget6', {}, widgets);
                    expect(node).to.not.equal(null);
                    console.log('TEST');
                    expect(node.innerHTML.indexOf('has string template') > -1).to.equal(true);
                    expect(dom.isNode(node.tNode)).to.equal(true);
                });
            });

            suite('inheritance', function () {
                xtest('it should inherit', function () {
                    var node = dom('b-widget', {}, document.body);
                    console.log('props', props);
                    expect(props.created.join(',')).to.equal('b,a');
                    expect(props.attached.join(',')).to.equal('b,a');
                    expect(props.base.join(',')).to.equal('b');
                    node.destroy();
                    props.restore();
                });
                xtest('it should inherit 3 deep', function () {
                    var node = dom('c-widget', {}, document.body);
                    console.log('props', props);
                    expect(props.created.join(',')).to.equal('c,b,a');
                    expect(props.attached.join(',')).to.equal('c,b,a');
                    expect(props.base.join(',')).to.equal('c,c');
                    props.restore();
                    node.destroy();
                });
                xtest('it should call lifecycle methods on subclassed if not on extended', function () {
                    var node = dom('d-widget', {}, document.body);
                    node.base();
                    console.log('props', props);
                    expect(props.created.join(',')).to.equal('a');
                    expect(props.attached.join(',')).to.equal('a');
                    expect(props.base.join(',')).to.equal('d');
                    props.restore();
                    node.destroy();
                });
                xtest('it should be able to use the base class template', function () {
                    var node = dom('f-widget', {}, document.body);
                    expect(node.innerHTML.indexOf('this is extended') > -1).to.equal(true);
                    //node.destroy();
                });
                test('it should be not call on prototypes without the method', function () {
                    var node = dom('missing-d', {}, document.body);
                    node.base();
                    console.log('props', props);
                    expect(props.attached.join(',')).to.equal('c,a');
                    expect(props.base.join(',')).to.equal('c,a');
                    node.destroy();
                    props.restore();
                });
                xtest('it should be able to use a deep base class template', function () {
                    var node = dom('g-widget', {}, document.body);
                    expect(node.innerHTML.indexOf('this is extended') > -1).to.equal(true);
                    //node.destroy();
                });
                xtest('it should inherit the domReady method', function (done) {
                    var node = dom('c-widget', {}, document.body);
                    create.onDomReady(node, function () {
                        console.log('props', props);
                        expect(props.domReady.join(',')).to.equal('c,b,a');
                        props.restore();
                        done();
                    });

                });
            });
        });

        mocha.run();

    </script>
</body>
</html>