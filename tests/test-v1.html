<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>Test BaseComponent</title>
    <link rel="stylesheet" href="../bower_components/mocha/mocha.css">
    <script src="../bower_components/mocha/mocha.js"></script>
    <script src="../bower_components/chai/chai.js"></script>
    <script src="../bower_components/on/dist/on.js"></script>
    <script src="../bower_components/dom/src/dom.js"></script>

    <script src="../src/loader.js" files="../dist/lifecycle"></script>

    <style>
        body{
            padding: 20px;
            font-family: sans-serif;
        }
        section{
            border: 1px solid #ccc;
            padding: 3px;
            margin: 5px;
        }
        section section{
            border: 0;
            padding: 0;
            margin: 0;
        }
    </style>
</head>
<body>
    <h1>Test BaseComponent</h1>

    <template id="test-tmpl-id-template">
        <div>This is a template byId</div>
    </template>


    <div id="mocha"></div>

    <script>

        // for collecting inheritance properties
        var props = {
            created:[],
            attached:[],
            base: [],
            domReady: [],
            restore: function () {
                this.created.length = 0;
                this.attached.length = 0;
                this.base.length = 0;
                this.domReady.length = 0;
            }
        };
    </script>

    <script>
        document.addEventListener('onComponentsReady', function () {
            mocha.setup('tdd');

            suite('BaseComponent', function () {
                this.timeout(3000);
                var suite = window.suite,
                    test = window.test,
                    dom = window.dom,
                    on = window.on,
                    expect = chai.expect,
                    body = document.body;

                function xsuite() {
                }

                function xtest() {
                }

                suite('create / destroy', function () {

                    test('it should create a component', function () {
                        var node = dom('test-lifecycle', {css:'foo'}, body);
                        expect(dom.isNode(node)).to.equal(true);
                        expect(typeof node.on).to.equal('function');
                        expect(node.DOMSTATE).to.equal('connected');
                    });

                    test('it should be destroyable', function () {
                        // uses node created in test above
                        var node = dom.query('test-lifecycle');
                        expect(dom.isNode(node)).to.equal(true);
                        node.destroy();
                        node = null;
                        node = dom.query('test-lifecycle');
                        expect(dom.isNode(node)).to.equal(false);
                    });

                    test('it should destroy event listeners', function () {
                        var
                            called = 0,
                            node = dom('test-lifecycle', {css:'foo'}, body);
                        node.on(document, 'test', function () {
                            called++;
                        });
                        on.emit(document, 'test');
                        node.destroy();
                        on.emit(document, 'test');
                        expect(called).to.equal(1);
                    });

                    // TODO: test inheritance
                });

                suite('plugins', function () {
                    test('it should connect to a plugin\'s events', function (done) {
                        var
                            called = 0,
                            onCalled = function () { called++; },
                            h = on.makeMultiHandle([
                                on(document, 'init-called', onCalled),
                                on(document, 'preConnected-called', onCalled),
                                on(document, 'postConnected-called', onCalled),
                                on(document, 'preDomReady-called', onCalled),
                                on(document, 'postDomReady-called', onCalled)
                            ]),
                            node = dom('test-lifecycle', {}, body);

                        node.on('domready', function () {
                            // timeout is due to postDomReady
                            setTimeout(function () {
                                expect(called).to.equal(5);
                                node.destroy();
                                h.remove();
                                done();
                            }, 1);
                        });
                    });
                });

                suite('lifecycle methods', function () {
                    test('it should call component\'s `connected` method', function () {
                        var
                            node,
                            called = false,
                            h = on(document, 'connected-called', function () {
                                called = true;
                            });
                        node = dom('test-lifecycle', {}, body);
                        expect(called).to.equal(true);
                        node.destroy();
                        h.remove();
                    });
                    test('it should call component\'s `disconnected` method', function () {
                        var
                            node,
                            called = 0,
                            h1 = on(document, 'connected-called', function () {
                                called++;
                            }),
                            h2 = on(document, 'disconnected-called', function () {
                                called++;
                            });
                        node = dom('test-lifecycle', {}, body);
                        body.removeChild(node);
                        body.appendChild(node);
                        expect(called).to.equal(3);
                        node.destroy();
                        h1.remove();
                        h2.remove();
                    });
                    test('it should call component\'s `domReady` method', function (done) {
                        var
                            node,
                            called = false,
                            h = on(document, 'domready-called', function () {
                                called = true;
                            });
                        node = dom('test-lifecycle', {}, body);
                        node.on('domready', function () {
                            expect(called).to.equal(true);
                            h.remove();
                            node.destroy();
                            done();
                        });
                    });
                    test('it should call component\'s `domReady` method when children are ready', function (done) {
                        var
                            node,
                            called = 0,
                            h = on(document, 'domready-called', function () {
                                called++;
                            });
                        node = dom('test-lifecycle', {}, body);
                        dom('test-lifecycle', {}, node);
                        dom('test-lifecycle', {}, node);
                        dom('test-lifecycle', {}, node);
                        node.on('domready', function () {
                            expect(called).to.equal(4);
                            h.remove();
                            node.destroy();
                            done();
                        });
                    });
                    test('it should call component\'s `domReady` method when descendants are ready', function (done) {
                        var
                            node,
                            called = 0,
                            h = on(document, 'domready-called', function () {
                                called++;
                            });

                        node = dom('test-lifecycle', {}, document.body);
                        dom('test-lifecycle', {
                            html: dom('test-lifecycle', {
                                html: dom('test-lifecycle', {
                                    html: dom('test-lifecycle', {})
                                })
                            })
                        }, node);
                        node.on('domready', function () {
                            expect(called).to.equal(5);
                            h.remove();
                            node.destroy();
                            done();
                        });
                    });

                    test('it should fire `connected` multiple times but `domready` once', function (done) {
                        var
                            called = 0,
                            onCalled = function () { called++; },
                            h = on.makeMultiHandle([
                                on(document, 'init-called', onCalled),
                                on(document, 'connected-called', onCalled),
                                on(document, 'domready-called', onCalled),
                                on(document, 'disconnected-called', onCalled)
                            ]),
                            node = dom('test-lifecycle', {}, body);

                        setTimeout(function () {
                            body.removeChild(node);
                            body.appendChild(node);
                            setTimeout(function () {
                                body.removeChild(node);
                                body.appendChild(node);
                                setTimeout(function () {
                                    expect(called).to.equal(7);
                                    node.destroy();
                                    h.remove();
                                    done();
                                }, 10);
                            }, 10);
                        }, 10);
                    });

                    test('it should fire `connected` in creation order, and `domready` in instantiation order', function (done) {
                        var
                            node,
                            connected = [],
                            domready = [],
                            h = on.makeMultiHandle([
                                on(document, 'connected-called', function (e) {
                                    connected.push(e.detail.className);
                                }),
                                on(document, 'domready-called', function (e) {
                                    domready.push(e.detail.className);
                                })
                            ]);

                        node = dom('test-lifecycle', {css:'1'}, document.body); // 1
                        dom('test-lifecycle', { css:'2',
                            html: dom('test-lifecycle', { css:'3',
                                html: dom('test-lifecycle', { css:'4',
                                    html: dom('test-lifecycle', {css:'5'})
                                })
                            })
                        }, node);

                        node.on('domready', function () {
                            h.remove();
                            node.destroy();
                            expect(connected.join(',')).to.equal('1,2,3,4,5');
                            expect(domready.join(',')).to.equal('5,4,3,2,1');
                            done();
                        });
                    });
                });

                suite('templates', function () {
                    test('it should create a component with a templateString', function () {
                        var node = dom('test-tmpl-string', {}, body);
                        expect(dom.isNode(node)).to.equal(true);
                        expect(node.innerHTML.indexOf('simple template') > -1).to.equal(true);
                        node.destroy();
                    });

                    test('it should create a component with a templateId', function () {
                        var node = dom('test-tmpl-id', {}, body);
                        expect(node).to.not.equal(null);
                        expect(node.innerHTML.indexOf('template byId') > -1).to.equal(true);
                        expect(dom.isNode(node)).to.equal(true);
                        node.destroy();
                    });
                });

                suite('template refs', function () {
                    test('it should reference nodes with the `ref` attribute', function () {
                        var node = dom('test-tmpl-refs', {}, body);
                        expect(dom.isNode(node.labelNode)).to.equal(true);
                        expect(dom.isNode(node.valueNode)).to.equal(true);
                        node.destroy();
                    });

                    test('it should attach events using the `ref` attribute', function () {
                        var
                            called = false,
                            node = dom('test-tmpl-refs', {}, body),
                            h = on(document, 'ref-click-called', function () {
                                called = true;
                            });

                        on.emit(node.clickNode, 'click');

                        expect(called).to.equal(true);
                        h.remove();
                        node.destroy();
                    });

                    test('it should insert light nodes into the container', function () {
                        var
                            content = 'I should be in the container',
                            node = dom('test-tmpl-container', {html:content}, body);
                        expect(dom.isNode(node.container)).to.equal(true);
                        expect(node.container.innerHTML).to.equal(content);
                        node.destroy();
                    });
                });

                suite('nested templates', function () {
                    test('it should nest templates', function () {
                        var
                            node = dom('test-tmpl-nested-b', {}, body),
                            content = dom.queryAll(node, 'div').map(function (n) {
                                return n.innerHTML;
                            }).join(',');

                        expect(dom.isNode(node)).to.equal(true);
                        expect(content).to.equal('content A before,content B,content A after');
                        node.destroy();
                    });

                    test('it should deeply nest sparse templates', function () {
                        var
                            node = dom('test-e', {}, body),
                            content = dom.queryAll(node, 'div').map(function (n) {
                                return n.innerHTML;
                            }).join(',');
                        expect(dom.isNode(node)).to.equal(true);
                        expect(content).to.equal('content B before,content D,content B after');
                        node.destroy();
                    });

                    test('it should nest templates and insert light dom', function () {
                        var
                            node = dom('test-tmpl-nested-c', {html:'Light DOM'}, body),
                            content = dom.queryAll(node, 'div').map(function (n) {
                                return n.innerHTML;
                            }).join(',');
                        console.log('content', content);
                        expect(dom.isNode(node)).to.equal(true);
                        expect(content).to.equal('content A before,content C before,Light DOM,content C after,content A after');
                        node.destroy();
                    });
                });

                suite('properties', function () {
                    test('it should sync properties and attributes', function () {
                        var node = dom('test-props', {attr:{foo:true}}, body);
                        expect(node.getAttribute('foo')).to.equal('true');
                        expect(node.foo).to.equal(true);

                        node.foo = 99;
                        expect(node.getAttribute('foo')).to.equal('99');
                        expect(node.foo).to.equal(99);

                        expect(node.getAttribute('bar')).to.equal(null);
                        expect(node.bar).to.equal(null);

                        node.bar = 88;
                        expect(node.getAttribute('bar')).to.equal('88');
                        expect(node.bar).to.equal(88);
                        expect(node['bar-changed']).to.equal(88);

                        node.setAttribute('bar', true);
                        expect(node.getAttribute('bar')).to.equal('true');
                        expect(node.bar).to.equal(true);

                        expect(node['bar-changed']).to.equal(true);
                    });

                    test('it should sync booleans and attributes', function (done) {
                        var node = dom('test-props', {attr:{nbc:true, disabled:true}}, body);
                        onDomReady(node, function () {
                            console.log('node', node);
                            expect(node.hasAttribute('nbc')).to.equal(true);
                            expect(node.nbc).to.equal(true);
                            expect(node.cbs).to.equal(false);

                            node.setAttribute('nbc', false);
                            node.setAttribute('cbs', true);

                            expect(node.nbc).to.equal(false);
                            expect(node.cbs).to.equal(true);
                            done();
                        });
                    });
                });

                xsuite('temp', function () {

                });
            });

            mocha.run();
        });

    </script>
</body>
</html>