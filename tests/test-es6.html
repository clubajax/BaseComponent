<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>Test BaseComponent</title>
    <link rel="stylesheet" href="../bower_components/mocha/mocha.css">
    <script src="../bower_components/on/dist/on.js"></script>
    <script src="../bower_components/dom/src/dom.js"></script>

    <script src="../src/loader.js" files="../dist/lifecycle.bundle"></script>

    <style>
        body{
            padding: 20px;
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <h1>Test BaseComponent</h1>
    <div id="mocha"></div>

    <script>

        // for collecting inheritance properties
        var props = {
            created:[],
            attached:[],
            base: [],
            domReady: [],
            restore: function () {
                this.created.length = 0;
                this.attached.length = 0;
                this.base.length = 0;
                this.domReady.length = 0;
            }
        };
    </script>

    <script>

        mocha.setup('tdd');

        suite('create-element', function () {
            this.timeout(3000);
            var suite = window.suite,
                test = window.test,
                dom = window.dom,
                on = window.on,
                expect = chai.expect,
                widgets = dom.byId('widgets');

            function xsuite () {}
            function xtest () {}

            xsuite('create', function () {

                test('it should create a component', function () {

                });



                // TODO: lifecycle (change to connect/disconnect)
                // TODO: test on/remove
                // TODO: test inheritance
            });

            xsuite('attributes', function () {
                test('it should reflect properties to attributes', function (done) {

                });
            });

            xsuite('lifecycle methods', function () {
                test('it should call component\'s `connected` method', function () {

                });
                test('it should call component\'s `domReady` method', function (done) {

                });
                test('it should call component\'s `domReady` method when children are ready', function (done) {
                    var node, called = 0;
                    on(window, 'domReady-called', function () {
                        called++;
                    });
                    node = dom('test-widget5', {}, document.body);
                    dom('test-child1', {}, node);
                    dom('test-child1', {}, node);
                    dom('test-child1', {}, node);
                    node.on('domready', function () {
                        expect(called).to.equal(4);
                        done();
                    });
                });
                test('it should call component\'s `domReady` method when descendants are ready', function (done) {
                    var node, called = 0;
                    on(window, 'domReady-called', function () {
                        called++;
                    });
                    node = dom('test-widget5', {}, document.body);
                    dom('test-child1', {
                        html: dom('test-child1', {
                            html: dom('test-child1', {
                                html: dom('test-child1', {})
                            })
                        })
                    }, node);
                    node.on('domready', function () {
                        expect(called).to.equal(5);
                        done();
                    });
                });

                // TODO test destroy
            });

            xsuite('templates', function () {
                test('it should create a component with a templateId', function () {
                    var node = dom('test-widget2', {html:'<div>test-widget2</div>'}, widgets);
                    expect(node).to.not.equal(null);
                    expect(node.innerHTML.indexOf('has template') > -1).to.equal(true);
                    expect(dom.isNode(node.testNode)).to.equal(true);
                    node.destroy();
                });
                test('it should create a component with a templateString', function () {
                    var node = dom('test-widget6', {}, widgets);
                    expect(node).to.not.equal(null);
                    expect(node.innerHTML.indexOf('has string template') > -1).to.equal(true);
                    expect(dom.isNode(node.tNode)).to.equal(true);
                    node.destroy();
                });
            });

            xsuite('inheritance', function () {
                test('it should inherit', function () {
                    var node = dom('b-widget', {}, document.body);
                    expect(props.created.join(',')).to.equal('b,a');
                    expect(props.attached.join(',')).to.equal('b,a');
                    expect(props.base.join(',')).to.equal('b');
                    node.destroy();
                    props.restore();
                });
                xtest('it should inherit 3 deep', function () {
                    var node = dom('c-widget', {}, document.body);
                    expect(props.created.join(',')).to.equal('c,b,a');
                    expect(props.attached.join(',')).to.equal('c,b,a');
                    expect(props.base.join(',')).to.equal('c,c');
                    props.restore();
                    node.destroy();
                });
                xtest('it should call lifecycle methods on subclassed if not on extended', function () {
                    var node = dom('d-widget', {}, document.body);
                    node.base();
                    expect(props.created.join(',')).to.equal('a');
                    expect(props.attached.join(',')).to.equal('a');
                    expect(props.base.join(',')).to.equal('d');
                    props.restore();
                    node.destroy();
                });
                test('it should be able to use the base class template', function () {
                    var node = dom('f-widget', {}, document.body);
                    expect(node.innerHTML.indexOf('this is extended') > -1).to.equal(true);
                    node.destroy();
                    props.restore();
                });
                xtest('it should handle a prototype chain with sparse methods', function () {
                    var node = dom('missing-d', {}, document.body);
                    node.base();
                    expect(props.attached.join(',')).to.equal('c,a');
                    expect(props.base.join(',')).to.equal('c,a');
                    node.destroy();
                    props.restore();
                });
                xtest('it should be able to use a deep base class template', function () {
                    var node = dom('g-widget', {}, document.body);
                    expect(node.innerHTML.indexOf('this is extended') > -1).to.equal(true);
                    node.destroy();
                    props.restore();
                });

                xtest('it should inherit the domReady method', function (done) {
                    var node = dom('c-widget', {}, document.body);
                    create.onDomReady(node, function () {
                        expect(props.domReady.join(',')).to.equal('c,b,a');
                        props.restore();
                        node.destroy();
                        done();
                    });

                });
            });

            xsuite('nested templates', function () {
                test('it should nest templates', function () {
                    var
                        str,
                        parent = dom.byId('widgets2');
                    parent.innerHTML = '';
                    parent.innerHTML = '<nested-b>light text</nested-b>';
                    str = parent.textContent;
                    str = str.replace(/\n/g, '').replace(/\t+/g, '').replace(/\s+/g, ' ').trim();
                    expect(str).to.equal('before nested a before nested b light text after nested b after nested a');
                    parent.innerHTML = '';
                });
            });

            xsuite('temp', function () {

            });
        });

        mocha.run();

    </script>
</body>
</html>